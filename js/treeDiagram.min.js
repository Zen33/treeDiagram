// Snapshot tree diagram proto 0.1 By tangzhen@inspur.com
!function(a){"use strict";function H(){return d3.time.format("%Y-%m-%d %H:%M:%S")(new Date)}function I(a){return F=[{name:E,type:"root",hint:"基础",children:[{name:a,type:"replica",hint:H(),children:[{name:"当前",type:"now"}]}]}],L(F)}function J(a){if(2===D)return void C.translate(z);d3.event&&d3.event.translate&&(z=d3.event.translate),d3.event&&d3.event.scale&&(A=d3.event.scale),a>=B[0]&&a<=B[1]&&(A=a,C.scale(A)),t.attr("transform","translate("+z+")scale("+A+")")}function K(){ea()&&(localStorage.ICSTreeGraphData=JSON.stringify(JSON.decycle(F)))}function L(d){var h;K(),q=$.extend([],d),d=d[0],s=r.nodes(d),$("svg#"+b).length||(t=d3.select("#"+g).append("svg").attr({id:b,width:i+c.right+c.left,height:j+c.top+c.bottom}).append("g").attr("transform","translate("+c.left+","+c.top+")"),w=$("svg#"+b),h=t.append("svg:defs"),Object.keys(f.type).forEach(function(a,b){h.append("svg:marker").attr({id:"arrow"+a,viewBox:"0 -5 10 10",refX:0,refY:0,markerWidth:5,markerHeight:5,orient:"auto"}).append("svg:path").attr("d","M0,-5L10,0L0,5")}),d3.select("body").append("div").attr({id:b+"Menu",class:"node-menu"}).html(e).style("display","none"),$("#"+b+"Menu li").click(function(){var c=this.getAttribute("rel");a.treeGraph[c]&&a.treeGraph[c](),$("#"+b+"Menu").hide()}),d3.select("svg#"+b).on("mousedown",function(){D=d3.event.button,d3.event.target===document.querySelector("#"+b)&&ca()}).call(C),t.append("svg:rect").attr({id:"highlight",width:f.width+10,height:f.height+10,fill:"#c2d6e8",rx:10,transform:"translate("+(i-f.width)/2+","+(j-f.height)/2+")","fill-opacity":1e-6})),p.push(f.width),d.id=d.id||Y(),d.y=P(d.id),d.x=0,d.level="0",d.depth=parseInt(d.level),k.push(d),Q(d.children),O(),W(x,[d]),N(d,k),d3.select(self.frameElement).style("height",j+"px")}function M(a,b){var c=d3.select(this),d=a.hint&&a.hint.toString().match(/.{1,10}/g)||[a.hint],e=0,g=d.length;if(g)for(c.text("");e<g;e+=1)c.append("tspan").text(d[e]).attr({x:f.width,dy:e?"1.2em":1.2*f.height,"text-anchor":"middle",class:"node-tspan"}).style("font-size",h)}function N(a,b,c){var d,e,g;b.forEach(function(a,b){var d,c=[];a.children&&(a.x0=a.x,a.x+=1.7*f.width,a.children.forEach(function(b){c.push({source:a,target:b})})),d=t.selectAll("path.link-index-"+b).data(c,function(a){return a.target.id}),d.enter().insert("svg:path","g").attr({d:function(a){var b={x:a.source.x0,y:a.source.y};return S({source:b,target:b})}}).style("opacity",1e-6),d.transition().duration(l).attr({"marker-end":function(a){return"url(#arrow"+(1===a.target["a-list"]?"root":"replica")+")"},class:function(a){return"link link-index-"+b+" link-"+(1===a.target["a-list"]?"root":"replica")+" link-"+a.target.id},d:S}).style("opacity",1),d.exit().transition().duration(l).attr("d",function(a){var b={x:a.source.x,y:a.source.y};return S({source:b,target:b})}).style("opacity",1e-6).remove()}),d=t.selectAll("g.node").data(b,function(a){return a.hasOwnProperty("id")?a.id:a.id=Y()}),e=d.enter().append("g").attr({class:function(a){return"node node-"+a.id},transform:function(a){return"translate("+(a.x0-2*f.width)+","+a.y+")"}}).style("opacity",1e-6),e.append("image").attr({x:f.height/2,y:-f.height/2,width:f.width,height:f.height,class:function(a){return"node-icon node-icon-"+a.type+" node-icon-"+a.id},"xlink:href":function(a){return f.type[a.type]}}).on("click",function(a){ba(a)}).on("contextmenu",da),e.append("title").text(function(a){return a.name}).attr("class",function(a){return"node-title node-title-"+a.id}),e.append("text").attr({x:f.width,dy:.9*f.height,"text-anchor":"middle",class:function(a){return"node-label node-label-"+a.type+" node-label-"+a.id}}).text(function(a){return aa(a.name,10,!0)}).style({"font-size":h,"font-weight":"bold"}),e.append("text").attr("class","node-hint"),t.selectAll("g text.node-hint").each(M),g=d.transition().duration(l).attr("transform",function(a){return"translate("+a.x0+","+a.y+")"}).style("opacity",1),g.selectAll("text").style("fill-opacity",1),d.exit().transition().duration(l).attr("transform",function(a){return"translate("+(a.x-2*f.width)+","+a.y+")"}).style("opacity",1e-6).remove(),c&&c(b)}function O(){var a=[];a[0]=0,k.forEach(function(b){b.x=0,b.level>0&&(b.x=a[b.level-1]+p[b.level-1]+1.7*f.width,a[b.level]=b.x),b.x0=b.x})}function P(a){var b=0;return s.some(function(c){if(c.id===a)return void(b=c.x)}),b}function Q(a,b){var b=b||1;a.forEach(function(a,c){var d=b;a.level=b,a.id=a.id||Y(),"now"===a.type&&(x=a),R(a),a.children&&(d+=1,Q(a.children,d))})}function R(a){a.y=P(a.id),void 0===p[a.level]&&(p[a.level]=f.width),a.depth=parseInt(a.level),k.push(a)}function S(a){var b=[],c=(a.source.x+a.target.x)/2;return b[0]=a.source.x+","+a.source.y,b[3]=a.target.x+","+a.target.y,b[1]=c+","+a.source.y,b[2]=c+","+a.target.y,"M"+b[0]+"C"+b[1]+" "+b[2]+" "+b[3]}function T(a,b,c){b=f.type[b]||b,c=c||"",t.select(".node-icon-"+a).attr("href",b),t.select(".node-label-"+a).text(aa(c,10,!0)),t.select(".node-title-"+a).text(c)}function U(a){if(!o){if(!F)return void I(a);if(m&&w.find(".node").length>=m)return void alert("最大节点总数不能超过："+m);var b={id:Y(),name:x.name,type:"now"};o=!0,x.children?x.children.unshift(b):x.children=[b],x.name=a||"",x.type="replica",x.hint=H(),V(),T(x.id,d,"正在创建..."),setTimeout(function(){T(x.id,"replica",a||""),L(F),o=!1},n)}}function V(){p.length=0,k.length=0,y.length=0,ca()}function W(a,b){var c;a["a-list"]=1,y.push(a.id),a.parent?(c=a.parent.children.indexOf(a),0!==c&&a.parent.children.splice(0,0,a.parent.children.splice(c,1)[0]),W(a.parent,b)):X(b)}function X(a){a.forEach(function(a){y.indexOf(a.id)<0&&(a["a-list"]=2),a.children&&X(a.children)})}function Y(){return""+Math.floor(1e4*Math.random()+1e4)}function Z(a){if(!o&&F&&v&&(!v||v.id!==x.id)){if(m&&w.find(".node").length>=m)return void alert("最大节点总数不能超过："+m);var c,b=v.id,e=function(a){$.each(a,function(d,f){if(f.id===b)return f.children=f.children||[],1===f.children.length&&(c=$.extend([],f.children[0].children),f.children[0]={id:Y(),name:f.children[0].name,type:"replica",hint:f.children[0].hint||H(),children:c}),f.children.unshift({id:Y(),name:"当前",type:"now"}),y.push(f.children[0].id),W(f,a),!1;f.children&&e(f.children)})},f=function(b){$.each(b,function(b,c){if("now"===c.type)return c.parent.children[b]={id:Y(),name:a||"",type:"replica",hint:H()},!1;c.children&&f(c.children)})};o=!0,V(),f(F),e(F),T(x.id,d,"正在还原..."),setTimeout(function(){L(F),o=!1},n)}}function _(b,c){var e;!arguments.length||o||["now","root"].indexOf(b.type)>-1||(c||(c=F,T(b.id,d,"正在删除...")),$.each(c,function(c,d){if(d.id===b.id)return 3===w.find(".node").length||"root"===d.parent.type&&1===d.parent.children.length&&d.children&&1===d.children.length&&!d.children[0].hasOwnProperty("children")?(o=!0,setTimeout(function(b){$(".node, .link").fadeOut(function(){$(b).remove(),V(),F=null,a.treeGraph.clear()}),o=!1},n,this),!1):(d.children?(e=$.extend([],d.children),d.parent.children.splice(c,1),e.forEach(function(a){d.parent.children.push(a)})):d.parent.children.splice(c,1),V(),o=!0,v=null,setTimeout(function(){L(F),o=!1},n),!1);d.children&&_(b,d.children)}))}function aa(a,b,c){for(var a=a||"",d=0,e="",f=/[^\x00-\xff]/g,g="",h=a.replace(f,"**").length,i=0;i<h&&(g=a.charAt(i).toString(),null!==g.match(f)?d+=2:d+=1,!(d>b));i+=1)e+=g;return c&&h>b&&(e+="..."),e}function ba(a){$(".snapshot-action").find('button[rel="restore"], button[rel="remove"]').prop("disabled","replica"!==a.type),d3.select("#highlight").transition().duration(100).ease("linear").attr("fill-opacity",1e-6).transition().duration(200).ease("linear").attr({transform:function(){return"translate("+(a.x0+f.width/2-5)+","+(a.y-f.height/2-5)+")"},"fill-opacity":1}),v=a}function ca(){d3.select("#highlight").transition().duration(300).ease("linear").attr("fill-opacity",1e-6),$(".snapshot-action").find('button[rel="restore"], button[rel="remove"]').prop("disabled",!0)}function da(a){var c,d;ba(a),d3.event.pageX||d3.event.pageY?(c=d3.event.pageX,d=d3.event.pageY):(d3.event.clientX||d3.event.clientY)&&(c=d3.event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d=d3.event.clientY+document.body.scrollTop+document.documentElement.scrollTop),d3.select("#"+b+"Menu").style({position:"absolute",left:c+"px",top:d+"px",display:"block"}).on("mouseleave",function(){d3.select(this).style("display","none")}),$("#"+b+"Menu li").hide(),["now","root"].indexOf(a.type)>-1?$("#"+b+"Menu li:not([class])").show():$("#"+b+"Menu li[class]").show(),d3.event.preventDefault()}function ea(){var a="test";try{return localStorage.setItem(a,a),localStorage.removeItem(a),!0}catch(a){return!1}}var q,s,t,v,w,x,D,F,b="snapshotTreeGraph",c={top:-40,right:120,bottom:20,left:120},d="img/spinner.gif",e='<ul><li rel="create">生成快照</li><li class="more" rel="restore">还原到快照...</li><li class="more" rel="remove">删除</li></ul>',f={width:42,height:42,type:{root:"img/1.png",replica:"img/2.png",now:"img/0.png"}},g="container",h="12px",i=($("#"+g).width()||1024)-c.right-c.left,j=($("#"+g).height()||768)-c.top-c.bottom,k=[],l=750,m=10,n=1e3,o=!1,p=[],r=d3.layout.tree().size([i,j]),y=(d3.scale.category20(),[]),z=[0,0],A=1,B=[.5,2],C=d3.behavior.zoom().scaleExtent(B).on("zoom",J),E="";(new Date).getTime();a.treeGraph={getStarted:L,remove:function(){_(v)},getNode:function(){return v},addNode:U,create:function(){$("#snapshotName").val(""),$(".snapshot-form").show(),$(".createSnapshot").show(),$(".restoreSnapshot").hide()},restore:function(){$("#snapshotName").val(""),$(".snapshot-form").show(),$(".createSnapshot").hide(),$(".restoreSnapshot").show()},restoreNode:Z,zoom:function(a){a=a||1,J(a)},clear:function(){ea()&&localStorage.removeItem("ICSTreeGraphData"),window.location.reload()},getData:function(){return q},init:function(a){var b=ea()&&localStorage.ICSTreeGraphData;if(b){try{F=JSON.parse(b)}catch(a){F=null}F?(E=F[0].name,L(F)):(ea()&&this.clear(),E=a)}else E=a;delete this.init}},a.treeGraph.init(""+(new Date).getTime())}(window.ICS=window.ICS||{}),$(function(){$(".snapshot-action button").click(function(a){var b=a.target.getAttribute("rel");ICS.treeGraph[b]&&ICS.treeGraph[b]()}),$(".createSnapshot").click(function(){ICS.treeGraph.addNode($("#snapshotName").val()),$(".snapshot-form").hide()}),$(".restoreSnapshot").click(function(){ICS.treeGraph.restoreNode($("#snapshotName").val()),$(".snapshot-form").hide()})});